# üîß H∆∞·ªõng D·∫´n C·∫•u H√¨nh Chi Ti·∫øt

## üìã M·ª•c L·ª•c
1. [C·∫•u H√¨nh Environment Variables](#c·∫•u-h√¨nh-environment-variables)
2. [C·∫•u H√¨nh InfluxDB](#c·∫•u-h√¨nh-influxdb)
3. [C·∫•u H√¨nh Grafana](#c·∫•u-h√¨nh-grafana)
4. [C·∫•u H√¨nh Prometheus](#c·∫•u-h√¨nh-prometheus)
5. [C·∫•u H√¨nh SNMP](#c·∫•u-h√¨nh-snmp)
6. [C·∫•u H√¨nh Custom Scripts](#c·∫•u-h√¨nh-custom-scripts)
7. [C·∫•u H√¨nh Alerts](#c·∫•u-h√¨nh-alerts)
8. [C·∫•u H√¨nh B·∫£o M·∫≠t](#c·∫•u-h√¨nh-b·∫£o-m·∫≠t)

## üåê C·∫•u H√¨nh Environment Variables

### File .env
File `.env` l√† trung t√¢m c·∫•u h√¨nh c·ªßa h·ªá th·ªëng. C√°c bi·∫øn quan tr·ªçng:

```env
# Module Control
ENABLE_INFLUXDB=true           # Core service - lu√¥n true
ENABLE_GRAFANA=true            # Core service - lu√¥n true  
ENABLE_PROMETHEUS=true         # Core service - lu√¥n true
ENABLE_SNMP=false             # B·∫≠t khi c·∫ßn monitor network devices
ENABLE_EXEC_SCRIPTS=false     # B·∫≠t khi c·∫ßn custom monitoring
ENABLE_ALERTMANAGER=false     # B·∫≠t khi c·∫ßn alerting

# Versions
INFLUXDB_VERSION=2.7.0        # Khuy·∫øn ngh·ªã d√πng version ·ªïn ƒë·ªãnh
GRAFANA_VERSION=10.0.0        # Version m·ªõi nh·∫•t
PROMETHEUS_VERSION=2.45.0     # LTS version
```

### T√πy Ch·ªânh Ports
```env
# Default ports
INFLUXDB_PORT=8086
GRAFANA_PORT=3000
PROMETHEUS_PORT=9090
NODE_EXPORTER_PORT=9100
ALERTMANAGER_PORT=9093

# Thay ƒë·ªïi n·∫øu conflict
GRAFANA_PORT=3001
PROMETHEUS_PORT=9091
```

### Resource Limits
```env
# ƒêi·ªÅu ch·ªânh theo kh·∫£ nƒÉng server
INFLUXDB_MEMORY_LIMIT=2g      # Min: 1g, Recommended: 2-4g
INFLUXDB_CPU_LIMIT=2          # Min: 1, Recommended: 2-4

GRAFANA_MEMORY_LIMIT=1g       # Min: 512m, Recommended: 1-2g
GRAFANA_CPU_LIMIT=1           # Min: 0.5, Recommended: 1-2

PROMETHEUS_MEMORY_LIMIT=2g    # Min: 1g, Recommended: 2-4g
PROMETHEUS_CPU_LIMIT=2        # Min: 1, Recommended: 2-4
```

## üíæ C·∫•u H√¨nh InfluxDB

### Database Settings
```env
# Organization v√† Bucket
INFLUXDB_ORG=monitoring-org
INFLUXDB_BUCKET=metrics
INFLUXDB_RETENTION=30d        # Th·ªùi gian l∆∞u data (7d, 30d, 90d, 1y)

# Initial Admin User
INFLUXDB_USERNAME=admin
INFLUXDB_PASSWORD=SecurePassword123!
INFLUXDB_TOKEN=<auto-generated>
```

### Storage Configuration
```env
# Data paths
INFLUXDB_DATA_PATH=./data/influxdb
INFLUXDB_CONFIG_PATH=./data/influxdb-config

# Ho·∫∑c d√πng absolute paths
INFLUXDB_DATA_PATH=/opt/monitoring/data/influxdb
```

### Performance Tuning
T·∫°o file `configs/influxdb/config.yml`:
```yaml
# InfluxDB 2.x config
bolt-path: /var/lib/influxdb2/influxdb.bolt
engine-path: /var/lib/influxdb2/engine
nats-port: 4222
http-bind-address: :8086
reporting-disabled: true

# Cache settings
cache-max-memory-size: 1073741824  # 1GB
cache-snapshot-memory-size: 26214400  # 25MB
```

## üìä C·∫•u H√¨nh Grafana

### Authentication
```env
# Admin credentials
GRAFANA_ADMIN_USER=admin
GRAFANA_ADMIN_PASSWORD=SecureGrafanaPass!

# Anonymous access (read-only)
GF_AUTH_ANONYMOUS_ENABLED=false
GF_AUTH_ANONYMOUS_ORG_ROLE=Viewer
```

### Plugins
```env
# Install plugins on startup
GRAFANA_PLUGINS=grafana-piechart-panel,grafana-worldmap-panel,grafana-clock-panel

# Ho·∫∑c c√†i th·ªß c√¥ng
docker exec -it monitoring-grafana grafana-cli plugins install <plugin-id>
```

### SMTP Configuration
Th√™m v√†o docker-compose.yml environment:
```yaml
environment:
  GF_SMTP_ENABLED: 'true'
  GF_SMTP_HOST: 'smtp.gmail.com:587'
  GF_SMTP_USER: 'your-email@gmail.com'
  GF_SMTP_PASSWORD: 'app-password'
  GF_SMTP_FROM_ADDRESS: 'your-email@gmail.com'
  GF_SMTP_FROM_NAME: 'Monitoring System'
```

### HTTPS Configuration
1. **T·∫°o certificates**:
```bash
# Self-signed cert
openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
  -keyout configs/grafana/grafana.key \
  -out configs/grafana/grafana.crt
```

2. **Update docker-compose.yml**:
```yaml
grafana:
  environment:
    GF_SERVER_PROTOCOL: https
    GF_SERVER_CERT_FILE: /etc/grafana/grafana.crt
    GF_SERVER_CERT_KEY: /etc/grafana/grafana.key
  volumes:
    - ./configs/grafana/grafana.crt:/etc/grafana/grafana.crt:ro
    - ./configs/grafana/grafana.key:/etc/grafana/grafana.key:ro
```

## üéØ C·∫•u H√¨nh Prometheus

### Scrape Intervals
Edit `configs/prometheus/prometheus.yml`:
```yaml
global:
  scrape_interval: 15s      # T·∫ßn su·∫•t thu th·∫≠p metrics
  evaluation_interval: 15s  # T·∫ßn su·∫•t ƒë√°nh gi√° rules
  scrape_timeout: 10s      # Timeout cho m·ªói scrape
```

### Adding Targets
1. **Static targets**:
```yaml
scrape_configs:
  - job_name: 'custom-servers'
    static_configs:
      - targets:
        - 'server1.example.com:9100'
        - 'server2.example.com:9100'
        labels:
          environment: 'production'
          region: 'us-east'
```

2. **File-based discovery**:
```yaml
scrape_configs:
  - job_name: 'dynamic-servers'
    file_sd_configs:
      - files:
        - '/etc/prometheus/targets/*.yml'
        refresh_interval: 30s
```

### Retention Policy
```env
# Time-based retention
PROMETHEUS_RETENTION_TIME=15d

# Size-based retention  
PROMETHEUS_RETENTION_SIZE=10GB
```

## üì° C·∫•u H√¨nh SNMP

### Basic SNMP v2c
```env
# Devices list
TELEGRAF_SNMP_AGENTS=switch1:192.168.1.10:161:public,router1:192.168.1.1:161:public

# SNMP settings
TELEGRAF_SNMP_VERSION=2c
TELEGRAF_SNMP_INTERVAL=60s
TELEGRAF_SNMP_TIMEOUT=10s
```

### SNMP v3 Configuration
```env
# Security settings
TELEGRAF_SNMP_VERSION=3
TELEGRAF_SNMP_SEC_NAME=snmpv3user
TELEGRAF_SNMP_AUTH_PROTOCOL=SHA
TELEGRAF_SNMP_AUTH_PASSWORD=authPassword123
TELEGRAF_SNMP_SEC_LEVEL=authPriv
TELEGRAF_SNMP_PRIV_PROTOCOL=AES
TELEGRAF_SNMP_PRIV_PASSWORD=privPassword123
```

### Custom OIDs
Edit `configs/telegraf/telegraf-snmp.conf`:
```toml
[[inputs.snmp]]
  # Custom OID for specific vendor
  [[inputs.snmp.field]]
    name = "custom_metric"
    oid = "1.3.6.1.4.1.9999.1.1.0"
    
  # Table with custom OIDs
  [[inputs.snmp.table]]
    name = "custom_table"
    oid = "1.3.6.1.4.1.9999.2"
    
    [[inputs.snmp.table.field]]
      name = "custom_field"
      oid = "1.3.6.1.4.1.9999.2.1.1"
```

## üìù C·∫•u H√¨nh Custom Scripts

### Script Requirements
Scripts ph·∫£i output theo format:
- **InfluxDB Line Protocol**: `measurement,tag1=value1 field1=value1,field2=value2 timestamp`
- **JSON**: `{"measurement": "name", "tags": {...}, "fields": {...}}`

### Example Scripts

1. **Bash Script** (`exec-scripts/system_info.sh`):
```bash
#!/bin/bash

# Get system load
LOAD=$(uptime | awk -F'load average:' '{print $2}' | awk -F, '{print $1}')

# Output in InfluxDB format
echo "system_load,host=$(hostname) value=$LOAD"
```

2. **Python Script** (`exec-scripts/app_metrics.py`):
```python
#!/usr/bin/env python3
import json
import psutil

# Get metrics
cpu_percent = psutil.cpu_percent(interval=1)
memory = psutil.virtual_memory()

# Output as JSON
data = {
    "measurement": "system_metrics",
    "tags": {
        "host": "app-server-01",
        "region": "us-east"
    },
    "fields": {
        "cpu_usage": cpu_percent,
        "memory_usage": memory.percent,
        "memory_available": memory.available
    }
}

print(json.dumps(data))
```

### Script Configuration
```env
# Execution settings
TELEGRAF_EXEC_INTERVAL=300s    # Run every 5 minutes
TELEGRAF_EXEC_TIMEOUT=30s      # Max execution time
TELEGRAF_EXEC_SCRIPTS_PATH=./exec-scripts
```

## üö® C·∫•u H√¨nh Alerts

### AlertManager Setup
```env
ENABLE_ALERTMANAGER=true
ALERTMANAGER_VERSION=0.25.0
ALERTMANAGER_PORT=9093
```

### Email Alerts
```env
ALERT_EMAIL_ENABLED=true
ALERT_EMAIL_HOST=smtp.gmail.com
ALERT_EMAIL_PORT=587
ALERT_EMAIL_USER=alerts@example.com
ALERT_EMAIL_PASSWORD=app-specific-password
ALERT_EMAIL_FROM=alerts@example.com
ALERT_EMAIL_TO=team@example.com
```

### Slack Alerts
```env
ALERT_SLACK_ENABLED=true
ALERT_SLACK_WEBHOOK=https://hooks.slack.com/services/YOUR/WEBHOOK/URL
ALERT_SLACK_CHANNEL=#monitoring-alerts
```

### Custom Alert Rules
Create `configs/prometheus/rules/custom-alerts.yml`:
```yaml
groups:
  - name: custom_alerts
    interval: 30s
    rules:
      - alert: HighResponseTime
        expr: http_request_duration_seconds{quantile="0.99"} > 1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High response time on {{ $labels.instance }}"
          description: "99th percentile response time is above 1s"
```

## üîí C·∫•u H√¨nh B·∫£o M·∫≠t

### Network Isolation
```yaml
# docker-compose.yml
networks:
  monitoring:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
```

### Access Control

1. **Reverse Proxy v·ªõi Nginx**:
```nginx
server {
    listen 443 ssl;
    server_name monitoring.example.com;
    
    ssl_certificate /etc/nginx/ssl/cert.pem;
    ssl_certificate_key /etc/nginx/ssl/key.pem;
    
    location / {
        proxy_pass http://localhost:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
    
    # Basic auth
    auth_basic "Monitoring Access";
    auth_basic_user_file /etc/nginx/.htpasswd;
}
```

2. **Firewall Rules**:
```bash
# Only allow access from specific IPs
iptables -A INPUT -p tcp --dport 3000 -s 10.0.0.0/8 -j ACCEPT
iptables -A INPUT -p tcp --dport 3000 -j DROP
```

### Secrets Management
```bash
# Use Docker secrets
echo "mypassword" | docker secret create grafana_admin_password -

# Reference in docker-compose.yml
services:
  grafana:
    secrets:
      - grafana_admin_password
    environment:
      GF_SECURITY_ADMIN_PASSWORD__FILE: /run/secrets/grafana_admin_password
```

## üîÑ Configuration Backup

### Backup Script
Create `scripts/backup-config.sh`:
```bash
#!/bin/bash

BACKUP_DIR="./backups/config-$(date +%Y%m%d-%H%M%S)"
mkdir -p "$BACKUP_DIR"

# Backup configs
cp -r configs/ "$BACKUP_DIR/"
cp .env "$BACKUP_DIR/"
cp docker-compose.yml "$BACKUP_DIR/"

# Compress
tar -czf "$BACKUP_DIR.tar.gz" "$BACKUP_DIR"
rm -rf "$BACKUP_DIR"

echo "Config backed up to $BACKUP_DIR.tar.gz"
```

### Restore Configuration
```bash
# Extract backup
tar -xzf backups/config-20240315-120000.tar.gz

# Restore files
cp -r config-20240315-120000/* ./

# Restart services
docker compose down
docker compose up -d
```